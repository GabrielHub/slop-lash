generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum GameStatus {
  LOBBY
  WRITING
  VOTING
  ROUND_RESULTS
  FINAL_RESULTS
}

enum PlayerType {
  HUMAN
  AI
}

enum TtsMode {
  OFF
  AI_VOICE
  BROWSER_VOICE
}

enum TtsVoice {
  MALE
  FEMALE
}

model Game {
  id              String     @id @default(cuid())
  roomCode        String     @unique
  status          GameStatus @default(LOBBY)
  currentRound    Int        @default(0)
  totalRounds     Int        @default(3)
  hostPlayerId    String?
  phaseDeadline   DateTime?
  timersDisabled  Boolean    @default(false)
  ttsMode         TtsMode    @default(OFF)
  ttsVoice        TtsVoice   @default(MALE)
  votingPromptIndex Int       @default(0)
  votingRevealing   Boolean   @default(false)
  nextGameCode    String?
  aiInputTokens   Int        @default(0)
  aiOutputTokens  Int        @default(0)
  aiCostUsd       Float      @default(0)
  version         Int        @default(0)
  createdAt       DateTime   @default(now())
  players         Player[]
  rounds          Round[]
  modelUsages     GameModelUsage[]

  @@index([status])
  @@index([createdAt])
}

model GameModelUsage {
  id            String @id @default(cuid())
  gameId        String
  game          Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  modelId       String
  inputTokens   Int    @default(0)
  outputTokens  Int    @default(0)
  costUsd       Float  @default(0)

  @@unique([gameId, modelId])
  @@index([gameId])
}

model Player {
  id          String             @id @default(cuid())
  gameId      String
  game        Game               @relation(fields: [gameId], references: [id], onDelete: Cascade)
  name        String
  type        PlayerType         @default(HUMAN)
  modelId     String?
  score       Int                @default(0)
  humorRating Float              @default(1.0)
  winStreak   Int                @default(0)
  lastSeen    DateTime           @default(now())
  responses   Response[]
  votes       Vote[]
  assignments PromptAssignment[]

  @@index([gameId])
}

model Round {
  id          String   @id @default(cuid())
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  roundNumber Int
  prompts     Prompt[]

  @@unique([gameId, roundNumber])
  @@index([gameId])
}

model Prompt {
  id          String             @id @default(cuid())
  roundId     String
  round       Round              @relation(fields: [roundId], references: [id], onDelete: Cascade)
  text        String
  ttsAudio    String?
  responses   Response[]
  votes       Vote[]
  assignments PromptAssignment[]

  @@index([roundId])
}

model PromptAssignment {
  id       String @id @default(cuid())
  promptId String
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([promptId, playerId])
  @@index([promptId])
  @@index([playerId])
}

model Response {
  id       String @id @default(cuid())
  promptId String
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  text         String
  pointsEarned Int    @default(0)
  votes        Vote[]

  @@unique([promptId, playerId])
  @@index([promptId])
  @@index([playerId])
}

model Vote {
  id         String    @id @default(cuid())
  promptId   String
  prompt     Prompt    @relation(fields: [promptId], references: [id], onDelete: Cascade)
  voterId    String
  voter      Player    @relation(fields: [voterId], references: [id], onDelete: Cascade)
  responseId String?
  response   Response? @relation(fields: [responseId], references: [id], onDelete: Cascade)

  @@unique([promptId, voterId])
  @@index([promptId])
  @@index([voterId])
  @@index([responseId])
}
