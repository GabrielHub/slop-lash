generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum GameStatus {
  LOBBY
  WRITING
  VOTING
  ROUND_RESULTS
  FINAL_RESULTS
}

enum PlayerType {
  HUMAN
  AI
  SPECTATOR
}

enum GameType {
  SLOPLASH
  AI_CHAT_SHOWDOWN
}

enum ParticipationStatus {
  ACTIVE
  DISCONNECTED
}

enum TtsMode {
  OFF
  ON
}

model Game {
  id              String     @id @default(cuid())
  roomCode        String     @unique
  gameType        GameType   @default(SLOPLASH)
  status          GameStatus @default(LOBBY)
  currentRound    Int        @default(0)
  totalRounds     Int        @default(3)
  hostPlayerId    String?
  hostControlTokenHash String?
  hostControlLastSeen  DateTime?
  phaseDeadline   DateTime?
  timersDisabled  Boolean    @default(false)
  ttsMode         TtsMode    @default(OFF)
  ttsVoice        String     @default("RANDOM")
  votingPromptIndex Int       @default(0)
  votingRevealing   Boolean   @default(false)
  nextGameCode    String?
  winnerTagline   String?
  aiInputTokens   Int        @default(0)
  aiOutputTokens  Int        @default(0)
  aiCostUsd       Float      @default(0)
  reactionsVersion Int       @default(0)
  version         Int        @default(0)
  createdAt       DateTime   @default(now())
  players         Player[]
  rounds          Round[]
  modelUsages     GameModelUsage[]
  chatMessages    ChatMessage[]

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}

model GameModelUsage {
  id            String @id @default(cuid())
  gameId        String
  game          Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  modelId       String
  inputTokens   Int    @default(0)
  outputTokens  Int    @default(0)
  costUsd       Float  @default(0)

  @@unique([gameId, modelId])
  @@index([gameId])
  @@index([modelId])
}

model LeaderboardAggregate {
  id             String   @id
  leaderboard    Json
  headToHead     Json
  bestResponses  Json
  modelUsage     Json
  stats          Json
  updatedAt      DateTime @updatedAt
}

model LeaderboardProcessedGame {
  gameId       String   @id
  processedAt  DateTime @default(now())
}

model Player {
  id                    String              @id @default(cuid())
  gameId                String
  game                  Game                @relation(fields: [gameId], references: [id], onDelete: Cascade)
  name                  String
  type                  PlayerType          @default(HUMAN)
  modelId               String?
  rejoinToken           String?
  idleRounds            Int                 @default(0)
  score                 Int                 @default(0)
  humorRating           Float               @default(1.0)
  winStreak             Int                 @default(0)
  participationStatus   ParticipationStatus @default(ACTIVE)
  lastSeen              DateTime            @default(now())
  responses             Response[]
  votes                 Vote[]
  assignments           PromptAssignment[]
  reactions             Reaction[]
  chatMessages          ChatMessage[]

  @@unique([gameId, rejoinToken])
  @@index([gameId])
}

model Round {
  id          String   @id @default(cuid())
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  roundNumber Int
  prompts     Prompt[]

  @@unique([gameId, roundNumber])
  @@index([gameId])
}

model Prompt {
  id          String             @id @default(cuid())
  roundId     String
  round       Round              @relation(fields: [roundId], references: [id], onDelete: Cascade)
  text        String
  responses   Response[]
  votes       Vote[]
  assignments PromptAssignment[]

  @@index([roundId])
}

model PromptAssignment {
  id       String @id @default(cuid())
  promptId String
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([promptId, playerId])
  @@index([promptId])
  @@index([playerId])
}

model Response {
  id       String @id @default(cuid())
  promptId String
  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  playerId String
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  text         String
  pointsEarned Int    @default(0)
  failReason   String?
  votes        Vote[]
  reactions    Reaction[]

  @@unique([promptId, playerId])
  @@index([promptId])
  @@index([playerId])
}

model Vote {
  id         String    @id @default(cuid())
  promptId   String
  prompt     Prompt    @relation(fields: [promptId], references: [id], onDelete: Cascade)
  voterId    String
  voter      Player    @relation(fields: [voterId], references: [id], onDelete: Cascade)
  responseId String?
  response   Response? @relation(fields: [responseId], references: [id], onDelete: Cascade)
  failReason String?

  @@unique([promptId, voterId])
  @@index([promptId])
  @@index([voterId])
  @@index([responseId])
}

model Reaction {
  id         String   @id @default(cuid())
  responseId String
  response   Response @relation(fields: [responseId], references: [id], onDelete: Cascade)
  playerId   String
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  emoji      String

  @@unique([responseId, playerId, emoji])
  @@index([responseId])
}

model ChatMessage {
  id          String   @id @default(cuid())
  gameId      String
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  roundNumber Int?
  content     String
  replyToId   String?
  replyTo     ChatMessage?  @relation("ChatReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     ChatMessage[] @relation("ChatReply")
  createdAt   DateTime @default(now())

  @@index([gameId, createdAt])
  @@index([gameId, roundNumber])
  @@index([playerId])
}
